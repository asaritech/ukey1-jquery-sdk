/*!
 * Ukey1 Jquery plugin (git@github.com:asaritech/ukey1-jquery-sdk.git)
 * Copyright 2017 Ukey1 Community (https://github.com/asaritech/ukey1-jquery-sdk/contributors)
 * Licensed under MIT
 */
!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof module&&module.exports?module.exports=function(o,n){return void 0===n&&(n="undefined"!=typeof window?require("jquery"):require("jquery")(o)),e(n),n}:e(jQuery)}(function(e){"use strict";function o(e){t("options",e,"object",!0),t("options.appId",e.appId,"string",!0),t("options.host",e.host,"string",!0),t("options.sdkVersion",e.sdkVersion,"string",!0),t("options.apiVersion",e.apiVersion,"string",!0),t("options.method",e.method,"string",!0,["GET","POST"]),t("options.endpoint",e.endpoint,"string",!0),t("options.accessToken",e.accessToken,"string",!1),this.o=e}function n(o){return t("options",o,"object",!0),t("options.appId",o.appId,"string",!0),o.sdkVersion=f,o.apiVersion=g,o.host||(o.host=e.ukey1.defaults.host),o}function t(e,o,n,r,s){if("array"===n){if(r&&!o||o&&"[object Array]"!==Object.prototype.toString.call(o))throw new Error("Unknown/invalid `"+e+"` ("+n+" required)")}else if("function"===n){if(r&&!o||o&&"[object Function]"!==Object.prototype.toString.call(o))throw new Error("Unknown/invalid `"+e+"` ("+n+" required)")}else if(r&&!o||o&&typeof o!==n)throw new Error("Unknown/invalid `"+e+"` ("+n+" required)");if("string"===n&&s&&(t("checkOption(attribute a)",s,"array",!1),s.indexOf(o)<0))throw new Error("Unknown/invalid `"+e+"` (possible values are ["+s.join(",")+"])")}function r(e,o){var n,t;return o||(o=window.location.href),o=decodeURIComponent(o),e=e.replace(/[\[\]]/g,"\\$&"),n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),t=n.exec(o),t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}function s(){return Math.random().toString(36).substr(2,10)+"-"+(new Date).getTime()}function i(e,o){var n=e.gateway.url;o.signup&&(n+=(n.search(/\?/)>=0?"&":"?")+"signup=1"),d?(d.setItem(a+"requestId",o.requestId),d.setItem(a+"connectId",e.connect_id)):(Cookies.set(a+"requestId",o.requestId),Cookies.set(a+"connectId",e.connect_id)),window.location=n}function c(e,n){var t,r="/me";n.accessToken=e.access_token,n.method="GET",n.endpoint=r,t=new o(n),t.send("",function(e){u(e,n)})}function u(e,o){if(!e.authorized)throw new Error("User has canceled their consent to share data with your app");o.success(e.user),o.finished(!0)}var d,a="uk1_jq_",p="localStorage"in window,l="sessionStorage"in window,h=Cookies&&"noConflict"in Cookies;if(l)d=sessionStorage;else if(p)d=localStorage;else if(!h)throw console.log("Web Storage is not supported!","Cookies plugin is not supported!"),new Error("There is a problem with browser storage!");e.ukey1=function(){};var f="1.0.0",g="/v1",I="_ukey1",w=1e4,k="ukey1-jquery-sdk/",y="UKEY1 ";e.ukey1.defaults={host:"https://ukey1-api.nooledge.com"},e.ukey1.prototype.connect=function(e){var r,c,u="/auth/connect",d=n(e);d.requestId=s(),t("options.requestId",d.requestId,"string",!0),t("options.returnUrl",d.returnUrl,"string",!0),t("options.scope",d.scope,"array",!1),d.method="POST",d.endpoint=u,r=new o(d),c={request_id:d.requestId,scope:d.scope,return_url:d.returnUrl},r.send(c,function(e){i(e,d)})},e.ukey1.prototype.accessToken=function(e){var s,i,u,p,l,h="/auth/token",f=n(e);return t("options.success",f.success,"function",!0),t("options.finished",f.finished,"function",!0),d?(f.requestId=d.getItem(a+"requestId")+"",f.connectId=d.getItem(a+"connectId")+"",d.removeItem(a+"requestId"),d.removeItem(a+"connectId")):(f.requestId=Cookies.get(a+"requestId")+"",f.connectId=Cookies.get(a+"connectId")+"",Cookies.remove(a+"requestId"),Cookies.remove(a+"connectId")),f.requestId&&f.connectId?(u=r(I+"[request_id]"),p=r(I+"[connect_id]"),l=r(I+"[result]"),u&&u===f.requestId?p&&p===f.connectId?"authorized"!==l?("canceled"===l?console.log("User has canceled the request"):"expired"===l?console.log("The request expired"):console.log("Unknown status"),f.finished(!1),!1):(f.method="POST",f.endpoint=h,s=new o(f),i={request_id:f.requestId,connect_id:f.connectId},void s.send(i,function(e){c(e,f)})):(console.log("Invalid connectId"),f.finished(!1),!1):(console.log("Invalid requestId"),f.finished(!1),!1)):(console.log("No requestId and connectId in device storage"),f.finished(!1),!1)},o.prototype.prepareHeaders=function(e){return e["x-ukey1-user-agent"]=e["User-Agent"]=this.prepareUserAgent(),e["x-ukey1-app"]=this.o.appId,this.o.accessToken&&(e.Authorization=y+this.o.accessToken),e},o.prototype.prepareUserAgent=function(){return k+this.o.sdkVersion+" Jquery/"+e.fn.jquery+(navigator?" "+navigator.userAgent:"")},o.prototype.send=function(o,n){var t={},r={};r=this.prepareHeaders(r),t.url=this.o.host+this.o.apiVersion+this.o.endpoint,t.method=t.type=this.o.method,t.timeout=w,t.jsonp=!1,t.dataType="json",t.success=function(e,o,t){var r={};if(!e.result)throw r=new Error("Invalid response structure"),r.response=e,r;if(e.result!==t.status)throw r=new Error("Unexpected HTTP status "+t.status),r.response=e,r;if(!(e.result>=200&&e.result<300))throw new Error(e.debug.message);n(e)},t.error=function(e,o,n){throw console.log(e.responseJSON.debug.message),n},o&&(r["Content-Type"]="application/json",t.data=JSON.stringify(o)),t.headers=r,e.ajax(t)}});